$(document).ready(function(){function t(t){var e=[];p.selectAll("rect").each(function(t,a){"white"!=$(this).attr("fill")&&e.push(t)}),s=[],o=0;for(var a=[],r=0;r<t.length;r++){a=[];for(var n=t[r]["Market Segments"],l=0;l<e.length;l++)if(n==e[l].MarketSegment)for(item in t[r])a.push({index:item,number:Number(t[r][item])}),o<Number(t[r][item])&&(o=Number(t[r][item]));a.pop(),a.length>0&&s.push({MarketSegment:n,values:a})}o=100*Math.ceil(o/100)}function e(){m=d3.scale.linear().domain([0,o]).rangeRound([l,0]),g=d3.svg.axis().scale(m).orient("left"),i.select("g.axis.yAxis").transition().duration(500).call(g);var t=d3.svg.line().x(function(t){return u(t.index)}).y(function(t){return m(t.number)}),e=i.selectAll("path.line").data(s).enter().append("path");e.attr("class","line").attr("d",function(e){return t(e.values)}).attr("transform","translate("+r.left+","+r.top+")").style("stroke",function(t){return c(t.MarketSegment)});for(var a=0;a<e[0].length;a++)d3.select(e[0][a]).attr("stroke-dasharray",e[0][a].getTotalLength()+" "+e[0][a].getTotalLength()).attr("stroke-dashoffset",e[0][a].getTotalLength()).transition().duration(500).ease("linear").attr("stroke-dashoffset",0)}function a(){i.selectAll("circle").remove(),i.selectAll(".vertical_line").remove(),i.selectAll("rect.bg_rect").remove(),$("div.tooltip tbody").html(""),bisectDate=d3.bisector(function(t){return t.index}).left;var t=i.selectAll("svg").data(s).enter().append("circle").attr("fill",function(t){return c(t.MarketSegment)}).attr("r",4).attr("display","none").attr("name",function(t){return t.MarketSegment});i.selectAll("circle").attr("transform",function(t){return"translate("+(r.left+u(t.values.index))+","+(r.top+m(t.values.number))+")"});var e=i.append("line").attr("class","vertical_line").attr("stroke-dasharray",10).attr("stroke","#a6a8ac").attr("stroke-width",.8).attr("display","none");i.append("rect").attr("class","bg_rect").attr("width",n).attr("height",l).attr("fill","none").attr("pointer-events","all").attr("transform","translate("+r.left+","+r.top+")").on("mouseover",function(){t.attr("display",null),e.attr("display",null),a.style("left",d3.event.pageX+"px").style("top",d3.event.pageY+20+"px").style("opacity",1)}).on("mouseout",function(){t.attr("display","none"),e.attr("display","none"),a.style("opacity",0)}).on("mousemove",function(){var t=u.invert(d3.mouse(this)[0]),n=[];for(key in s){var i=s[key].values,o=bisectDate(i,t,1),c=i[o-1],f=i[o];d=t-c.index>f.index-t?f:c,n.push(d)}var g=[],h,v;$("circle").each(function(t){$(this).attr("transform","translate("+(r.left+u(n[t].index))+","+(r.top+m(n[t].number))+")"),h=$(this).attr("fill"),v=$(this).attr("name"),g.push({color:h,name:v,number:n[t].number})}),g.sort(function(t,e){return e.number-t.number}),p.html("");for(var o=0;o<g.length;o++)p.append("<tr><td><span class='color' style='background-color:"+g[o].color+"'></span><span>"+g[o].name+"</span></td><td class='value'>"+g[o].number+"</td></tr>");e.attr("x1",r.left+u(n[0].index)).attr("x2",r.left+u(n[0].index)).attr("y1",r.top).attr("y2",l+r.top),a.style("left",d3.event.pageX+"px").style("top",d3.event.pageY+20+"px")});var a=d3.select("body").append("div").attr("class","tooltip").style("opacity",0),o="<table><tbody></tbody></table>";a.html(o);var p=$("div.tooltip tbody")}var r={top:30,bottom:30,left:50,right:200},n=1200-r.left-r.right,l=650-r.top-r.bottom,i=d3.select("div#svg").append("svg").attr("width",n+r.left+r.right).attr("height",l+r.top+r.bottom),s=[],o=0,c=d3.scale.category10(),p,u,f,m,g;d3.tsv("data/Persistence_3_localDENovartis_Apps_Persistence-19_.txt",function(d,h){for(var v=[],b=0;b<h.length;b++){var y=0;v=[];for(item in h[b])v.push({index:item,number:Number(h[b][item])}),o<Number(h[b][item])&&(o=Number(h[b][item]));v.pop();var x=h[b]["Market Segments"];s.push({MarketSegment:x,values:v})}p=i.selectAll("g.legend").data(s).enter().append("g").attr("class","legend"),p.append("rect").attr("stroke",function(t,e){return c(t.MarketSegment)}).attr("fill",function(t,e){return c(t.MarketSegment)}).attr("x",n+r.left+r.right-120).attr("y",function(t,e){return r.top+20*e}).attr("width",20).attr("height",10).on("click",function(r){var n=c(r.MarketSegment);"white"==$(this).attr("fill")?$(this).attr("fill",n):$(this).attr("fill","white"),i.selectAll(".line").remove(),t(h),e(),a()}),p.append("text").attr("x",n+r.left+r.right-90).attr("y",function(t,e){return r.top+20*e}).attr("dominant-baseline","hanging").text(function(t,e){return t.MarketSegment}),u=d3.scale.linear().domain([0,12]).range([0,n]),f=d3.svg.axis().scale(u).orient("bottom"),o=100*Math.ceil(o/100),m=d3.scale.linear().domain([0,o]).rangeRound([l,0]),g=d3.svg.axis().scale(m).orient("left"),i.append("g").attr("class","axis no_line_axis").attr("transform","translate("+r.left+","+(l+r.top)+")").transition().duration(500).call(f),i.append("g").attr("class","axis yAxis").attr("transform","translate("+r.left+","+r.top+")").transition().duration(500).call(g),e(),a()}),$.ajax({url:"data/Persistence_3_localDENovartis_Apps_Persistence-19_.txt",success:function(t){for(var e="",a=t.split("\n"),r=0;r<a.length;r++){var n=a[r].split("	");if(0==r){for(var l=0;l<n.length;l++)e=e+"<th>"+n[l]+"</th>";$("table thead").append("<tr>"+e+"</tr>")}else{for(var l=0;l<n.length;l++)e=e+"<td>"+n[l]+"</td>";$("table tbody").append("<tr>"+e+"</tr>")}e=""}}})});