$(document).ready(function(){var t=640,e=660,a=350,r=20,n=80,l=50,s=50,o,i,u,d,c=0,p=0,f=[],m=[],v=[],b=d3.select("div#svg").append("svg").attr("width",t).attr("height",e),g=d3.scale.category10(),h;d3.tsv("data/localDENovartis_Apps_SoB-12_BETACYN_Total.txt",function(d,y){function x(){var t=[];h.selectAll("rect").each(function(e,a){"white"!=$(this).attr("fill")&&t.push(e)});var e=[],a=0,r=0;c=p=0,m=[];for(var n=0;n<f.length;n++){for(var l=0;l<y.length;l++)for(var s=0;s<t.length;s++)y[l].Components==t[s]&&(Number(y[l][f[n]])>=0?a+=Number(y[l][f[n]]):r+=Number(y[l][f[n]]),e.push({name:y[l].Components,number:Number(y[l][f[n]])}));e.sort(function(t,e){return e.number-t.number}),a>c&&(c=a),p>r&&(p=r),a=0,r=0,m.push({date:f[n],values:e}),e=[]}p=100*Math.floor(p/100),c=100*Math.ceil(c/100)}function A(){h=b.selectAll("g.legend").data(v).enter().append("g").attr("class","legend"),h.append("rect").attr("stroke",function(t,e){return g(t)}).attr("fill",function(t,e){return g(t)}).attr("x",t-100).attr("y",function(t,e){return r+20*e}).attr("width",20).attr("height",10).on("click",function(t){var e=g(t);"white"==$(this).attr("fill")?$(this).attr("fill",e):$(this).attr("fill","white"),b.select("g.item").remove(),x(),k(),N()}),h.append("text").attr("x",t-60).attr("y",function(t,e){return r+20*e}).attr("dominant-baseline","hanging").text(function(t,e){return t})}function k(){u=d3.scale.linear().domain([p,c]).range([e-r-n,0]),yAxis=d3.svg.axis().scale(u).tickValues(d3.range(p,c,500)).orient("left"),b.select("g.axis.yAxis").transition().duration(500).call(yAxis),b.select("g.axis.xAxis").transition().duration(500).attr("transform","translate("+l+","+(e-n-(e-r-n-u(0)))+")").call(i).selectAll("text").attr("y",e-r-(e-n-(e-r-n-u(0))));var o=b.selectAll("g.item").data(m).enter().append("g").attr("class","item"),d=(t-l-s)/m.length-a,f=o.selectAll("rect").data(m[0].values).enter().append("rect");f.attr("height",0).attr("y",function(t,a){var l=0,s=0,o=e-r-n-u(0);if(t.number>=0){for(var i=0;a>i;i++)f.data()[i].number>0?l=l+e-r-n-u(f.data()[i].number)-o:l+=0;return s=e-n-(e-r-n-u(0))-l}if(t.number<0){for(var i=0;a>i;i++)f.data()[i].number<0?l=l+e-r-n-u(-1*f.data()[i].number)-o:l+=0;return s=e-n-(e-r-n-u(0))+l}}).transition().duration(function(t){var a=e-r-n-u(0);return t.number>0?e-r-n-u(t.number)-a+100:t.number<0?e-r-n-u(-1*t.number)-a+100:0}).ease("swing").delay(function(t,a){var l=0,s=e-r-n-u(0);if(t.number>0){for(var o=0;a>o;o++)f.data()[o].number>0&&(l=l+e-r-n-u(f.data()[o].number)-s+100);return l}if(t.number<0){for(var o=0;a>o;o++)f.data()[o].number<0&&(l=l+e-r-n-u(-1*f.data()[o].number)-s+100);return l}return 0}).attr("fill",function(t,e){return g(t.name)}).attr("x",function(t,e){return l+a/2}).attr("y",function(t,a){var l=0,s=0,o=e-r-n-u(0);if(t.number>=0){for(var i=0;a>=i;i++)f.data()[i].number>0?l=l+e-r-n-u(f.data()[i].number)-o:l+=0;return s=e-n-(e-r-n-u(0))-l}if(t.number<0){for(var i=0;a>i;i++)f.data()[i].number<0?l=l+e-r-n-u(-1*f.data()[i].number)-o:l+=0;return s=e-n-(e-r-n-u(0))+l}}).attr("width",function(t,e){return d}).attr("height",function(t,a){var l=e-r-n-u(0);return t.number>0?e-r-n-u(t.number)-l:t.number<0?e-r-n-u(-1*t.number)-l:0})}function N(){var t=d3.select("body").append("div").attr("class","tooltip").style("opacity",0);t.html("<table><tbody></tbody></table>");var e=$("div.tooltip tbody");b.selectAll("g.item").selectAll("rect").on("mouseover",function(a){e.html(""),e.append("<tr><td>"+m[0].date+"</td></tr>");for(var r=[],n=[],l=0;l<m[0].values.length;l++)m[0].values[l].number>0?r.push(m[0].values[l]):n.push(m[0].values[l]);for(var l=r.length-1;l>=0;l--)e.append("<tr><td><span class='color' style='background-color:"+g(r[l].name)+"'></span><span>"+r[l].name+"</span></td><td class='value'>"+r[l].number+"</td></tr>");for(var l=0;l<n.length;l++)e.append("<tr><td><span class='color' style='background-color:"+g(n[l].name)+"'></span><span>"+n[l].name+"</span></td><td class='value'>"+n[l].number+"</td></tr>");t.style("left",d3.event.pageX+"px").style("top",d3.event.pageY+20+"px").style("opacity",1)}).on("mousemove",function(e){t.style("left",d3.event.pageX+"px").style("top",d3.event.pageY+20+"px")}).on("mouseout",function(e){t.style("opacity",0)})}for(var _ in y[0])f.push(_);f.splice(0,1);for(key in y)v.push(y[key].Components);A(),x(),o=d3.scale.ordinal().domain(f).rangeRoundBands([0,t-l-s]),i=d3.svg.axis().scale(o).orient("bottom"),p=100*Math.floor(p/100),c=100*Math.ceil(c/100),u=d3.scale.linear().domain([p,c]).range([e-r-n,0]),yAxis=d3.svg.axis().scale(u).tickValues(d3.range(p,c,500)).orient("left"),b.append("g").attr("class","axis xAxis").attr("transform","translate("+l+","+(e-n-(e-r-n-u(0)))+")").transition().duration(500).call(i).selectAll("text").attr("y",180),b.append("g").attr("class","axis yAxis").attr("transform","translate("+l+","+r+")").transition().duration(500).call(yAxis),k(),N()}),$.ajax({url:"data/localDENovartis_Apps_SoB-12_BETACYN_Total.txt",success:function(t){for(var e="",a=t.split("\n"),r=0;r<a.length;r++){var n=a[r].split("	");if(0==r){for(var l=0;l<n.length;l++)e=e+"<th>"+n[l]+"</th>";$("table thead").append("<tr>"+e+"</tr>")}else{for(var l=0;l<n.length;l++)e=e+"<td>"+n[l]+"</td>";$("table tbody").append("<tr>"+e+"</tr>")}e=""}}})});