function sob(t,e){svg.selectAll("*").remove(),$("div.tooltip").remove(),d3.tsv("data/localDENovartis_Apps_SoB-12_"+t+"_"+e+".txt",function(t,r){"Month"==e&&(barPadding=10,processData(r),svg.selectAll(".xAxis").selectAll("text").attr("x",-10).attr("font-size","10px").attr("text-anchor","middle").attr("transform","rotate(-23)")),"Quarter"==e&&(barPadding=30,processData(r)),"MAT"==e&&(barPadding=120,processData(r)),"Total"==e&&(barPadding=500,processData(r))})}function processData(t){function e(){return d3.svg.axis().scale(A).orient("left")}function r(){var e=[];b.selectAll("rect").each(function(t,r){"white"!=$(this).attr("fill")&&e.push(t.name)});var r=[],a=[],n=0,i=0;o=l=0,u=[];for(var m=0;m<s.length;m++){for(var g=0;g<t.length;g++)for(var c=0;c<e.length;c++)t[g].Components==e[c]&&(Number(t[g][s[m]])>=0?n+=Number(t[g][s[m]]):i+=Number(t[g][s[m]]),r.push({name:t[g].Components,number:Number(t[g][s[m]]),color:colors[g]}));for(var v=0;v<componentSet.length;v++)for(item in r)componentSet[v]==r[item].name&&a.push(r[item]);n>o&&(o=n),l>i&&(l=i),n=0,i=0,u.push({date:s[m],values:a}),r=[],a=[]}}function a(){function t(){return d3.svg.axis().scale(A).orient("left")}o>100&&(l=100*Math.floor(l/100),o=100*Math.ceil(o/100)),A=d3.scale.linear().domain([l,o]).range([h,0]),N=d3.svg.axis().scale(A).orient("left"),svg.select(".yAxis").attr("transform","translate("+margin.left+","+margin.top+")").transition().duration(500).call(N),svg.append("g").attr("class","grid").call(t().tickSize(-w,0,0).tickFormat("")).attr("transform","translate("+margin.left+","+margin.top+")");for(var e=svg.selectAll("g.item").data(u).enter().append("g").attr("class","item"),r=w/u.length-barPadding,a=0;a<u[0].values.length;a++)e.append("rect").attr("height",0).attr("y",function(t,e){var r=0,n=0,o=h-A(0);if(t.values[a].number>=0){for(var l=0;a>l;l++)t.values[l].number>0?r=r+h-A(t.values[l].number)-o:r+=0;return n=h+margin.top-o-r}if(t.values[a].number<0){for(var l=0;a>l;l++)t.values[l].number<0?r=r+h-A(-1*t.values[l].number)-o:r+=0;return n=h+margin.top-o+r}}).transition().duration(function(t){var e=h-A(0);return t.values[a].number>0?h-A(t.values[a].number)-e:t.values[a].number<0?h-A(-1*t.values[a].number)-e:0}).ease("swing").delay(function(t){var e=0,r=h-A(0);if(t.values[a].number>0){for(var n=0;a>n;n++)t.values[n].number>0&&(e=e+h-A(t.values[n].number)-r);return e}if(t.values[a].number<0){for(var n=0;a>n;n++)t.values[n].number<0&&(e=e+h-A(-1*t.values[n].number)-r);return e}return 0}).attr("x",function(t,e){return margin.left+(2*e+1)*barPadding/2+r*e}).attr("y",function(t,e){var r=0,n=0,o=h-A(0);if(t.values[a].number>=0){for(var l=0;a>=l;l++)t.values[l].number>0?r=r+h-A(t.values[l].number)-o:r+=0;return n=h+margin.top-o-r}if(t.values[a].number<0){for(var l=0;a>l;l++)t.values[l].number<0?r=r+h-A(-1*t.values[l].number)-o:r+=0;return n=h+margin.top-o+r}}).attr("fill",function(t){return t.values[a].color}).attr("height",function(t,e){var r=h-A(0);return t.values[a].number>0?h-A(t.values[a].number)-r:t.values[a].number<0?h-A(-1*t.values[a].number)-r:0}).attr("width",function(t,e){return r})}function n(){var t=svg.selectAll("g.item"),e=d3.select("body").append("div").attr("class","tooltip").style("opacity",0);e.html("<table><tbody></tbody></table>");var r=$("div.tooltip tbody");t.on("mouseover",function(t){r.html(""),r.append("<tr><td>"+t.date+"</td></tr>");for(var a=[],n=[],o=0;o<t.values.length;o++)t.values[o].number>0?a.push(t.values[o]):n.push(t.values[o]);for(var o=a.length-1;o>=0;o--)r.append("<tr><td class='value'>"+a[o].number+"</td><td><span class='text-right'>"+a[o].name+"</span></td></tr>");for(var o=0;o<n.length;o++)r.append("<tr><td class='value'>"+n[o].number+"</td><td><span>"+n[o].name+"</span></td></tr>");e.style("left",d3.event.pageX+25+"px").style("top",d3.event.pageY+"px").style("opacity",1)}).on("mousemove",function(t){e.style("left",d3.event.pageX+25+"px").style("top",d3.event.pageY+"px")}).on("mouseout",function(t){e.style("opacity",0)})}var o=0,l=0,s=[];for(var i in t[0])s.push(i);s.splice(0,1);for(var u=[],m=[],g=[],c=0,v=0,d=0;d<s.length;d++){for(var f=0;f<t.length;f++)Number(t[f][s[d]])>=0?c+=Number(t[f][s[d]]):v+=Number(t[f][s[d]]),m.push({name:t[f].Components,number:Number(t[f][s[d]]),color:colors[f]});for(var p=0;p<componentSet.length;p++)for(item in m)componentSet[p]==m[item].name&&g.push(m[item]);c>o&&(o=c),l>v&&(l=v),c=0,v=0,u.push({date:s[d],values:g}),m=[],g=[]}var b=svg.selectAll("g.legend").data(legendSet).enter().append("g").attr("class","legend");b.append("rect").attr("stroke",function(t,e){return t.color}).attr("fill",function(t,e){return t.color}).attr("x",margin.left+w+margin.right-180).attr("y",function(t,e){return margin.top+20*e}).attr("width",20).attr("height",10).on("click",function(t){var e=t.color;"white"==$(this).attr("fill")?$(this).attr("fill",e):$(this).attr("fill","white"),svg.selectAll("g.item").remove(),svg.selectAll("g.grid").remove(),r(),a(),n()}),b.append("text").attr("x",margin.left+w+margin.right-140).attr("y",function(t,e){return margin.top+20*e}).attr("dominant-baseline","hanging").text(function(t,e){return t.name});var x=d3.scale.ordinal().domain(s).rangeRoundBands([0,w]),y=d3.svg.axis().scale(x).orient("bottom").outerTickSize(0);o>100&&(l=100*Math.floor(l/100),o=100*Math.ceil(o/100));var A=d3.scale.linear().domain([l,o]).range([h,0]),N=d3.svg.axis().scale(A).orient("left");svg.append("g").attr("class","no_line_axis xAxis").attr("transform","translate("+margin.left+","+(h+margin.top)+")").transition().duration(500).call(y).selectAll("text").attr("y",30),svg.append("g").attr("class","no_line_axis yAxis").attr("transform","translate("+margin.left+","+margin.top+")").transition().duration(500).call(N),svg.append("g").attr("class","grid").call(e().tickSize(-w,0,0).tickFormat("")).attr("transform","translate("+margin.left+","+margin.top+")"),a(),n()}var barPadding=10,margin={top:50,bottom:80,left:120,right:260},w=$("body").width()-margin.left-margin.right,h=700-margin.top-margin.bottom,colors=["rgb(116,184,111)","rgb(72,139,67)","rgb(168,205,165)","rgb(142,69,69)","rgb(170,115,115)","rgb(114,22,22)","rgb(227,208,208)","rgb(65,99,153)","rgb(163,195,247)"],componentSet=["Repeat","Restart","Win","New","Add-On","Loss","Off Drug","End","Drop-Off"],legendSet=[{name:"Add-On",color:"rgb(168,205,165)"},{name:"New",color:"rgb(116,184,111)"},{name:"Win",color:"rgb(72,139,67)"},{name:"Restart",color:"rgb(163,195,247)"},{name:"Repeat",color:"rgb(65,99,153)"},{name:"Loss",color:"rgb(114,22,22)"},{name:"Off Drug",color:"rgb(142,69,69)"},{name:"End",color:"rgb(170,115,115)"},{name:"Drop-Off",color:"rgb(227,208,208)"}],svg=d3.select("div#svg").append("svg").attr("width",w+margin.left+margin.right).attr("height",700);