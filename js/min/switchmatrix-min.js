function drawSwitchMatrix(t){function n(){i="Widgets",c=d3.select(window),d=$("#sankey-chart").width(),h=$("#sankey-chart").height(),s={top:50,right:250,bottom:50,left:50},f=1100-s.left-s.right,l=900-s.top-s.bottom,y=d3.format(",.0f"),g=function(t){return y(t)+" "+i},b.attr("width",f+s.left+s.right).attr("height",l+s.top+s.bottom),k=b.append("g").attr("transform","translate("+s.left+","+s.top+")"),p=d3.sankey().nodeWidth(2).nodePadding(48).size([f,l]),m=p.link()}function r(){d3.tsv("data/localDENovartis_Apps_SoB-12_SwitchMatrix_"+t+".txt",function(t,n){v=[];for(key in n)-1==$.inArray(n[key].Product,u)&&u.push(n[key].Product),-1==$.inArray(n[key].Target,u)&&u.push(n[key].Target);u.sort();for(var r=0;r<n.length;r++)v.push({source:n[r].Product,target:n[r].Target+"-t",value:n[r].Patients}),void 0===o[v[r].source]&&(o[v[r].source]={title:v[r].source}),void 0===o[v[r].target]&&(o[v[r].target]={title2:v[r].target.replace("-t","")});e()})}function e(){E={nodes:[],links:[]},v.forEach(function(t){E.nodes.push({name:t.source}),E.nodes.push({name:t.target}),E.links.push({source:t.source,target:t.target,value:+t.value})}),E.nodes=d3.keys(d3.nest().key(function(t){return t.name}).map(E.nodes)),E.links.forEach(function(t,n){E.links[n].source=E.nodes.indexOf(E.links[n].source),E.links[n].target=E.nodes.indexOf(E.links[n].target)}),E.nodes.forEach(function(t,n){E.nodes[n]={name:t}}),p.nodes(E.nodes).links(E.links).layout(32),x=k.selectAll(".link").data(E.links).enter().append("path"),x.attr("class","link").attr("d",m).attr("data-key-source",function(t){return t.source.name}).attr("data-key-target",function(t){return t.target.name}).style("stroke-width",function(t){return Math.max(1,t.dy)}).style("stroke",function(t){return a(t.source.name)}).sort(function(t,n){return n.dy-t.dy}).attr("transform","scale(-1,1) rotate(90 0 0)"),L=k.selectAll(".node").data(E.nodes).enter().append("g"),L.attr("class","node").attr("data-key",function(t){return t.name}).attr("transform",function(t){return"translate("+t.y+","+t.x+")"}),L.append("rect").attr("width",function(t){return t.dy}).attr("height",10).style("fill",function(t){return a(t.name.replace("-t",""))}),L.append("text").attr("class","left-label").attr("y",function(t){return t.dx/2}).attr("x",function(t){return t.dy/2}).attr("dy","-.70em").attr("dx",".35em").attr("text-anchor","middle").text(function(t){return o[t.name].title}).on("click",function(t){return console.log("clicked: "+t)}),L.append("text").attr("class","right-label").attr("y",function(t){return t.dx/2+20}).attr("x",function(t){return t.dy/2}).attr("dy",".70em").attr("dx",".35em").attr("text-anchor","middle").text(function(t){return o[t.name].title2}),L.on("click",function(t){console.log("clicked: "+t)});var t=b.selectAll("g.legend").data(u).enter().append("g").attr("class","legend");t.append("rect").attr("stroke",function(t,n){return a(t)}).attr("fill",function(t,n){return a(t)}).attr("x",s.left+f+s.right-140).attr("y",function(t,n){return s.top+20*n}).attr("width",20).attr("height",10),t.append("text").attr("x",s.left+f+s.right-100).attr("y",function(t,n){return s.top+20*n}).attr("dominant-baseline","hanging").text(function(t,n){return t})}var a=d3.scale.category20c(),o={},u=[];d3.sankey=function(){function t(){y.forEach(function(t){t.sourceLinks=[],t.targetLinks=[]}),k.forEach(function(t){var n=t.source,r=t.target;"number"==typeof n&&(n=t.source=y[t.source]),"number"==typeof r&&(r=t.target=y[t.target]),n.sourceLinks.push(t),r.targetLinks.push(t)})}function n(){y.forEach(function(t){t.value=Math.max(d3.sum(t.sourceLinks,s),d3.sum(t.targetLinks,s))})}function r(){for(var t=y,n,r=0;t.length;)n=[],t.forEach(function(t){t.x=r,t.dx=d,t.sourceLinks.forEach(function(t){n.push(t.target)})}),t=n,++r;a(r),o((f-d)/(r-1))}function e(){y.forEach(function(t){t.targetLinks.length||(t.x=d3.min(t.sourceLinks,function(t){return t.target.x})-1)})}function a(t){y.forEach(function(n){n.sourceLinks.length||(n.x=t-1)})}function o(t){y.forEach(function(n){n.x*=t})}function u(t){function n(){var t=d3.min(u,function(t){return(g[1]-(t.length-1)*h)/d3.sum(t,s)});u.forEach(function(n){n.forEach(function(n,r){n.y=r,n.dy=n.value*t})}),k.forEach(function(n){n.dy=n.value*t})}function r(t){function n(t){return c(t.source)*t.value}u.forEach(function(r,e){r.forEach(function(r){if(r.targetLinks.length){var e=d3.sum(r.targetLinks,n)/d3.sum(r.targetLinks,s);r.y+=(e-c(r))*t}})})}function e(t){function n(t){return c(t.target)*t.value}u.slice().reverse().forEach(function(r){r.forEach(function(r){if(r.sourceLinks.length){var e=d3.sum(r.sourceLinks,n)/d3.sum(r.sourceLinks,s);r.y+=(e-c(r))*t}})})}function a(){u.forEach(function(t){var n,r,e=0,a=t.length,u;for(t.sort(o),u=0;a>u;++u)n=t[u],r=e-n.y,r>0&&(n.y+=r),e=n.y+n.dy+h;if(r=e-h-g[1],r>0)for(e=n.y-=r,u=a-2;u>=0;--u)n=t[u],r=n.y+n.dy+h-e,r>0&&(n.y-=r),e=n.y})}function o(t,n){return t.y-n.y}var u=d3.nest().key(function(t){return t.x}).sortKeys(d3.ascending).entries(y).map(function(t){return t.values});n(),a();for(var i=1;t>0;--t)e(i*=.99),a(),r(i),a()}function i(){function t(t,n){return t.source.y-n.source.y}function n(t,n){return t.target.y-n.target.y}y.forEach(function(r){r.sourceLinks.sort(n),r.targetLinks.sort(t)}),y.forEach(function(t){var n=0,r=0;t.sourceLinks.forEach(function(t){t.sy=n,n+=t.dy}),t.targetLinks.forEach(function(t){t.ty=r,r+=t.dy})})}function c(t){return 0}function s(t){return t.value}var l={},d=24,h=8,g=[1,1],y=[],k=[];return l.nodeWidth=function(t){return arguments.length?(d=+t,l):d},l.nodePadding=function(t){return arguments.length?(h=+t,l):h},l.nodes=function(t){return arguments.length?(y=t,l):y},l.links=function(t){return arguments.length?(k=t,l):k},l.size=function(t){return arguments.length?(g=t,l):g},l.layout=function(e){return t(),n(),r(),u(e),i(),l},l.relayout=function(){return i(),l},l.link=function(){function t(t){var r=t.source.x+t.source.dx,e=t.target.x,a=d3.interpolateNumber(r,e),o=a(n),u=a(1-n),i=t.source.y+t.sy+t.dy/2,c=t.target.y+t.ty+t.dy/2;return"M"+r+","+i+"C"+o+","+i+" "+u+","+c+" "+e+","+c}var n=.5;return t.curvature=function(r){return arguments.length?(n=+r,t):n},t},l};var i,c,s,f,l,d,h,g,y,k,p,m,v,x,E,L,b=d3.select("#sankey-chart").append("svg"),w=function(){d=$("#sankey-container").width(),h=$("#sankey-container").height(),f=d-s.left-s.right,l=500-s.top-s.bottom,b.attr("width",d).attr("height",600),p.size([f,l]),m=p.link(),L.selectAll(".node").attr("transform",function(t){return"translate("+t.x+","+t.y+")"}),x.selectAll(".link").attr("d",m)};n(),r(),c.on("resize.sankey",function(){b.html(""),w(),n(),e()}),$.ajax({url:"data/localDENovartis_Apps_SoB-12_SwitchMatrix_"+t+".txt",success:function(t){for(var n="",r=t.split("\n"),e=0;e<r.length;e++){var a=r[e].split("	");if(0==e){for(var o=0;o<a.length;o++)n=n+"<th>"+a[o]+"</th>";$("table thead").append("<tr>"+n+"</tr>")}else{for(var o=0;o<a.length;o++)n=n+"<td>"+a[o]+"</td>";$("table tbody").append("<tr>"+n+"</tr>")}n=""}}})}